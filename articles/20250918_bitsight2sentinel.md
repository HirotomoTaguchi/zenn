---
title: "Microsoft SentinelとBitSightの連携とハマりポイント"
emoji: "🤖" 
type: "tech" # tech: 技術記事 / idea: アイデア記事
topics: [Sentinel] 
published: false
published_at: 2025-09-18 22:00
---

今回は、Microsoft SentinelにBitSightのセキュリティレーティングを取り込もうと思い立ち、データコネクタの設定に挑戦したときの話です。公式の手順書通りに進めれば大丈夫だろうと高を括っていたら、最後の最後でエラーにぶつかり、少しだけ時間を溶かしてしまいました…。この記事が、同じ道を通る誰かの助けになれば幸いです。

## 連携手順は意外とシンプル（なはずだった）

まずは、今回実施した連携手順の全体像です。基本的には、BitSightから情報を取得するための「Azure Functions」をデプロイし、必要な権限を設定していく流れになります。

### STEP 1: BitSight APIトークンの準備

BitSightからデータを取得するための鍵が必要です。BitSightの管理画面にログインし、アカウント設定から**APIトークン**を取得します。これは後ほどARMテンプレートで使用するので、大切に保管しておきましょう。

### STEP 2 & 3: Entra IDでのアプリ登録とシークレット発行

次にAzure側です。今回の連携処理を実行する主体として、Microsoft Entra ID に新しい**アプリを登録**します。[Azure Portal] > [Microsoft Entra ID] > [アプリの登録] から新規登録を行うと、「**アプリケーション（クライアント）ID**」と「**テナントID**」が発行されます。これも後で使う重要情報です。

続けて、そのアプリの認証情報として**クライアントシークレット**も作成します。作成直後にしか表示されないので、これも忘れずにコピーしておきましょう。

### STEP 4: アプリケーションへの権限付与

今回デプロイするリソースグループに対して、「**共同作成者 (Contributor)**」の権限を割り当てておきます。

### STEP 5: ARMテンプレートによる一括デプロイ

いよいよ本番です。Sentinelのコネクタページにある「**Deploy to Azure**」ボタンをクリックすると、Azure portalでおなじみのARMテンプレートのデプロイ画面が開きます。ここに、これまで準備してきた情報を入力していきます。

画面には多くのパラメータ入力欄が並んでいますが、主要なものは以下の通りです。

  * **`API_token`**: STEP 1で取得したBitSightのAPIトークンです。
  * **`Azure_Client_Id`**: STEP 2で登録したAzure ADアプリケーションの「アプリケーション（クライアント）ID」です。
  * **`Azure_Client_Secret`**: STEP 3で作成したクライアントシークレットの値です。
  * **`Azure_Tenant_Id`**: STEP 2で確認したAzure ADの「テナントID」です。
  * **`Azure_Entra_Object_Id`**: **今回のハマりポイント**となったIDです。
  * **`Workspace ID`** と **`Workspace Key`**: データの送信先となるMicrosoft Sentinel（Log Analyticsワークスペース）のIDと主キーです。ワークスペースの「エージェント」設定ページからコピーできます。

すべての情報を入力し、「デプロイ！」とボタンをクリックします。

## ハマりポイント

しばらく待っていると、デプロイに失敗した旨の無慈悲な通知が。エラーの詳細を確認すると、このようなメッセージが表示されていました。

```json
{
  "code": "DeploymentFailed",
  "message": "At least one resource deployment operation failed. ...",
  "details": [
    {
      "code": "PrincipalTypeNotSupported",
      "message": "型が Application のプリンシパルをロールの割り当てに使用することはできません。"
    }
  ]
}
```

「**型が Application のプリンシパルをロールの割り当てに使用することはできません。**」

正直、最初は何のことか分かりませんでした。「プリンシパル？Application型？」と頭にハテナが浮かびます。エラーメッセージから、どうやらロールの割り当てで何か問題が起きているらしいことは推測できましたが、原因の特定には少し時間がかかりました。

このエラーの核心は、Azureにおける**アプリケーションのID体系の理解**にありました。

EntraID には、「**アプリの登録**」とその実体である「**エンタープライズアプリケーション（サービスプリンシパル）**」という2つの概念が存在します。

  * **アプリの登録**：アプリケーションの設計図やテンプレートのようなもので、グローバルに一意な存在です。
  * **エンタープライズアプリケーション**：その設計図を基に、テナント内に作成されたアプリケーションの実体です。私たちが権限（ロール）を割り当てるのは、この「実体」に対してです。

そして、この両者はそれぞれ異なる**オブジェクトID**を持っています。

私がARMテンプレートの `Azure_Entra_Object_Id` に入力していたのは、「アプリの登録」画面からコピーしたオブジェクトIDでした。しかし、テンプレート内で行われるロール割り当てが求めていたのは、「エンタープライズアプリケーション」のオブジェクトIDだったのです。設計図に「この土地で作業していいよ」と許可を与えようとして、「いや、許可を出す相手は実際に作業する人（実体）じゃないと困る」と怒られてしまった、というわけです。

## 解決策：正しいオブジェクトIDを登録する

原因が分かれば解決は簡単です。正しいオブジェクトIDを探しに行きましょう。

1.  Azure portalで **[Microsoft Entra ID]** を開きます。
2.  左側のメニューから **[エンタープライズ アプリケーション]** を選択します。（「アプリの登録」ではありません！）
3.  STEP 2で作成したアプリケーションの名前で検索し、該当のアプリを選択します。
4.  概要ページに表示されている「**オブジェクト ID**」をコピーします。

このIDこそが、今回のデプロイで必要だった真のオブジェクトIDです。ARMテンプレートのデプロイ画面に戻り、`Azure_Entra_Object_Id` の値に今コピーしたIDを貼り付けて再度実行したところ、今度は無事にデプロイが成功しました！

## おわりに

今回は、Microsoft SentinelとBitSightの連携における、ちょっとした落とし穴について共有しました。Azure（EntraID）のID管理の仕組みは奥が深く、特に「アプリの登録」と「エンタープライズアプリケーション」の違いは、こうしたロール割り当ての場面でつまずきやすいポイントだと思います。この記事が、同じエラーで悩む方の時間短縮に繋がれば嬉しいです。
