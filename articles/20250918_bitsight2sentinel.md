---
title: "Microsoft SentinelとBitSightの連携とハマりポイント"
emoji: "🤖" 
type: "tech" # tech: 技術記事 / idea: アイデア記事
topics: [Sentinel] 
published: true
published_at: 2025-09-18 22:00
---

今回は、Microsoft SentinelにBitSightのセキュリティレーティングを取り込もうと思い立ち、データコネクタの設定に挑戦したときの話です。公式の手順書通りに進めれば大丈夫だろうと高を括っていたら、最後の最後でエラーにぶつかり、少しだけ時間を溶かしてしまいました…。この記事が、同じ道を通る誰かの助けになれば幸いです。

## 連携手順は意外とシンプル（なはずだった）

まずは、今回実施した連携手順の全体像です。基本的には、BitSightから情報を取得するための「Azure Functions」をデプロイし、必要な権限を設定していく流れになります。

### STEP 1: BitSight APIトークンの準備

BitSightからデータを取得するための鍵が必要です。BitSightの管理画面にログインし、アカウント設定から**APIトークン**を取得します。これは後ほどARMテンプレートで使用するので、大切に保管しておきましょう。

### STEP 2 & 3: Entra IDでのアプリ登録とシークレット発行

次にAzure側です。今回の連携処理を実行する主体として、Microsoft Entra ID に新しい**アプリを登録**します。[Azure Portal] > [Microsoft Entra ID] > [アプリの登録] から新規登録を行うと、「**アプリケーション（クライアント）ID**」と「**テナントID**」が発行されます。これも後で使う重要情報です。

続けて、そのアプリの認証情報として**クライアントシークレット**も作成します。作成直後にしか表示されないので、これも忘れずにコピーしておきましょう。

### STEP 4: アプリケーションへの権限付与

今回デプロイするリソースグループに対して、「**共同作成者 (Contributor)**」の権限を割り当てておきます。

### STEP 5: ARMテンプレートによる一括デプロイ

いよいよ本番です。Sentinelのコネクタページにある「**Deploy to Azure**」ボタンをクリックすると、Azure portalでおなじみのARMテンプレートのデプロイ画面が開きます。ここに、これまで準備してきた情報を入力していきます。

画面には多くのパラメータ入力欄が並んでいますが、主要なものは以下の通りです。

  * **`API_token`**: STEP 1で取得したBitSightのAPIトークンです。
  * **`Azure_Client_Id`**: STEP 2で登録したAzure ADアプリケーションの「アプリケーション（クライアント）ID」です。
  * **`Azure_Client_Secret`**: STEP 3で作成したクライアントシークレットの値です。
  * **`Azure_Tenant_Id`**: STEP 2で確認したAzure ADの「テナントID」です。
  * **`Azure_Entra_Object_Id`**: **今回のハマりポイント**となったIDです。
  * **`Workspace ID`** と **`Workspace Key`**: データの送信先となるMicrosoft Sentinel（Log Analyticsワークスペース）のIDと主キーです。ワークスペースの「エージェント」設定ページからコピーできます。

すべての情報を入力し、「デプロイ！」とボタンをクリックします。

## ハマりポイント

しばらく待っていると、デプロイに失敗した旨の無慈悲な通知が。エラーの詳細を確認すると、このようなメッセージが表示されていました。

```json
{
  "code": "DeploymentFailed",
  "message": "At least one resource deployment operation failed. ...",
  "details": [
    {
      "code": "PrincipalTypeNotSupported",
      "message": "型が Application のプリンシパルをロールの割り当てに使用することはできません。"
    }
  ]
}
```

「**型が Application のプリンシパルをロールの割り当てに使用することはできません。**」

正直、最初は何のことか分かりませんでした。「プリンシパル？Application型？」と頭にハテナが浮かびます。エラーメッセージから、どうやらロールの割り当てで何か問題が起きているらしいことは推測できましたが、原因の特定には少し時間がかかりました。

このエラーの根本原因は、AzureにおけるアプリケーションのID管理の仕組みを正しく理解していなかったことでした。Microsoft Entra IDには、「アプリの登録」と「エンタープライズアプリケーション（サービスプリンシパル）」という2つの重要な概念が存在します。![[Microsoft Entra アプリを登録し、サービス プリンシパルを作成する](https://learn.microsoft.com/en-us/entra/identity-platform/howto-create-service-principal-portal)]

- アプリの登録：アプリケーションの設計図や定義のようなもので、アプリケーションの基本情報（名前、認証設定、APIアクセス許可など）を管理します。
- エンタープライズアプリケーション（サービスプリンシパル）：アプリの登録を基に、テナント内に作成されたアプリケーションの実行可能な実体です。実際にAzureリソースにアクセスする際は、この実体が使用されます。

重要なのは、この両者はそれぞれ異なるオブジェクトIDを持っているということです。そして、Azure RBACでロール（権限）を割り当てる際は、「アプリの登録」ではなく、「エンタープライズアプリケーション（サービスプリンシパル）」のオブジェクトIDを使用する必要があります。私がARMテンプレートの Azure_Entra_Object_Id に入力していたのは、「アプリの登録」画面からコピーしたオブジェクトIDでした。しかし、テンプレート内で行われるロール割り当てが実際に必要としていたのは、「エンタープライズアプリケーション」のオブジェクトIDだったのです。

これは、建築に例えるなら、設計図（アプリの登録）に「この土地で作業する権利」を与えようとしたところ、「権利を付与する対象は、実際に作業を行う作業員（サービスプリンシパル）でなければならない」と指摘されたようなものです。

## 解決策：正しいオブジェクトIDを登録する

原因が分かれば解決は簡単です。正しいオブジェクトIDを探しに行きましょう。

1.  Azure portalで **[Microsoft Entra ID]** を開きます。
2.  左側のメニューから **[エンタープライズ アプリケーション]** を選択します。（「アプリの登録」ではありません！）
3.  STEP 2で作成したアプリケーションの名前で検索し、該当のアプリを選択します。
4.  概要ページに表示されている「**オブジェクト ID**」をコピーします。

![](https://github.com/user-attachments/assets/cad9f40b-2f64-4eb6-add1-96a7fb184143)

このIDこそが、今回のデプロイで必要だった真のオブジェクトIDです。ARMテンプレートのデプロイ画面に戻り、`Azure_Entra_Object_Id` の値に今コピーしたIDを貼り付けて再度実行したところ、今度は無事にデプロイが成功しました！

## おわりに

今回は、Microsoft SentinelとBitSightの連携における、ちょっとした落とし穴について共有しました。Azure（EntraID）の仕組みは奥が深く、特に「アプリの登録」と「エンタープライズアプリケーション」の違いは、こうしたロール割り当ての場面でつまずきやすいポイントだと思います。この記事が、同じエラーで悩む方の時間短縮に繋がれば嬉しいです。
