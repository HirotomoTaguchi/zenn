---
title: "ã€å°ãƒã‚¿ã€‘Sentinelã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‹ç”¨çŠ¶æ³ã‚’æœˆæ¬¡ã§é›†è¨ˆã—Slackã§é€šçŸ¥ã™ã‚‹"
emoji: "ðŸ’»" 
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢è¨˜äº‹
topics: [Sentinel] 
published: true
published_at: 2024-12-09 07:00
---

Microsoft Security Advent Calendar 2024 ã®9æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚æœ¬è¨˜äº‹ã§ã¯ã€Logic Appã¨KQLã‚¯ã‚¨ãƒªã‚’çµ„ã¿åˆã‚ã›ã¦ã€å‰æœˆã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆé›†è¨ˆçµæžœã‚’Slackã«è‡ªå‹•é€šçŸ¥ã™ã‚‹ã¾ã§ã®æµã‚Œã¨ã€ãã®å®Ÿè£…ä¸Šã®ãƒã‚¤ãƒ³ãƒˆã‚’ç´¹ä»‹ã—ã¾ã™ã€‚å°ãƒã‚¿ã§æç¸®ã§ã™ãŒã€ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚

## èƒŒæ™¯

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‹ç”¨ãƒãƒ¼ãƒ ã§ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆã®ç®¡ç†ã¨å¯¾å¿œçŠ¶æ³ã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã€æ¬¡ã®ã‚ˆã†ãªè¦ä»¶ãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚

1. å‰æœˆç™ºç”Ÿã—ãŸã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®ç·æ•°ã¨ã€æœªã‚¯ãƒ­ãƒ¼ã‚ºã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆæ•°ã‚’é›†è¨ˆã—ãŸã„
2. é›†è¨ˆçµæžœã‚’Slackã§å…±æœ‰ã—ã€ãƒãƒ¼ãƒ å…¨ä½“ã§å‰æœˆã®æŒ¯ã‚Šè¿”ã‚Šã‚’è¡Œã„ãŸã„
3. å®Ÿè¡Œã¯æ¯Žæœˆ5æ—¥ã«è‡ªå‹•çš„ã«è¡Œã‚ã‚Œã‚‹ã‚ˆã†ã«ã—ãŸã„

ã“ã“ã§ã¯ã€Logic Appã‚’ç”¨ã„ã¦ã€æœˆæ¬¡ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã‚’è¡Œã„ã€Sentinel ã®ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦KQLã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ãã®çµæžœã‚’æ•´å½¢ã—ã¦Slackã«ãƒã‚¹ãƒˆã™ã‚‹ä¸€é€£ã®ãƒ•ãƒ­ãƒ¼ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

## å…¨ä½“åƒ

1. Logic Appã®ãƒˆãƒªã‚¬ãƒ¼ï¼šæœˆæ¬¡ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ãƒˆãƒªã‚¬ãƒ¼ã‚’åˆ©ç”¨ã—ã€æ¯Žæœˆ1æ—¥ã«å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ã€‚
2. Azure Monitor Logs ã‚³ãƒã‚¯ã‚¿ã‚’ç”¨ã„ã¦ã€Sentinelãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦KQLã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
3. KQLã‚¯ã‚¨ãƒªã§ã€å‰æœˆã«ç™ºç”Ÿã—ãŸã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®ç·æ•°ã¨æœªã‚¯ãƒ­ãƒ¼ã‚ºæ•°ã‚’é›†è¨ˆã—ã¾ã™ã€‚
4. é›†è¨ˆçµæžœã‚’Slackç”¨ã«æ•´å½¢ã—ã€Slackãƒãƒ£ãƒ³ãƒãƒ«ã¸ãƒã‚¹ãƒˆã—ã¾ã™ã€‚

## ã‚¯ã‚¨ãƒªä¾‹ã¨è§£èª¬

### å‰æœˆã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆé›†è¨ˆã‚¯ã‚¨ãƒª

ä¸‹è¨˜ã¯ã€`SecurityIncident`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”¨ã„ã¦ã€å‰æœˆã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç·æ•°ã¨æœªã‚¯ãƒ­ãƒ¼ã‚ºã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆæ•°ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®KQLã‚¯ã‚¨ãƒªä¾‹ã§ã™ã€‚

```kql
// å¤‰æ•°å®šç¾©
let FirstOfLastMonth = startofmonth(ago(1d), -1);
let StartOfThisMonth = startofmonth(ago(1d));
// ãƒ¡ã‚¤ãƒ³ã‚¯ã‚¨ãƒª
SecurityIncident
| where TimeGenerated >= FirstOfLastMonth
| where CreatedTime >= FirstOfLastMonth and CreatedTime < StartOfThisMonth
| summarize arg_max(TimeGenerated, *) by IncidentNumber
| summarize
    TotalIncidents = count(),
    OpenIncidents = countif(Status != "Closed")
| extend
    Message = strcat(
        "å‰æœˆã¯åˆè¨ˆ", tostring(TotalIncidents), "ä»¶ã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ã€",
        "ãã®ã†ã¡", tostring(OpenIncidents), "ä»¶ãŒæœªã‚¯ãƒ­ãƒ¼ã‚ºã§ã™ã€‚"
    )
| project Message, TotalIncidents, OpenIncidents
```

### ãƒã‚¤ãƒ³ãƒˆè§£èª¬

- `FirstOfLastMonth` ãŠã‚ˆã³ `StartOfThisMonth` ã¯ã€ãã‚Œãžã‚Œã€Œå‰æœˆã®åˆæ—¥ã€ã¨ã€Œå½“æœˆã®åˆæ—¥ã€ã‚’ç¤ºã™å¤‰æ•°ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å‰æœˆåˆ†ã®ã¿ã‚’æŠ½å‡ºã™ã‚‹æ™‚é–“ç¯„å›²ãŒæ˜Žç¢ºã«ãªã‚Šã¾ã™ã€‚
- `arg_max(TimeGenerated, *) by IncidentNumber` ã¯ã€åŒä¸€IncidentNumberã§æœ€æ–°ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã€æœ€çµ‚çš„ãªã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚„ãƒ¡ã‚¿æƒ…å ±ã‚’é›†ç´„ã—ã¾ã™ã€‚
- `summarize count(), countif(...)` ã§ã€å‰æœˆç™ºç”Ÿåˆ†ã®ãƒˆãƒ¼ã‚¿ãƒ«ãŠã‚ˆã³æœªã‚¯ãƒ­ãƒ¼ã‚ºæ•°ã‚’å–å¾—ã—ã¾ã™ã€‚
- `Message`åˆ—ã§ã€äººé–“ãŒã‚ã‹ã‚Šã‚„ã™ã„å½¢ã§ã¾ã¨ã‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã€`SecurityIncident`ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆæ›´æ–°ã®ãŸã³ã«è¨˜éŒ²ãŒè¿½åŠ ã•ã‚Œã‚‹å½¢å¼ã®ãŸã‚ã€å˜ç´”ãª`count`ã‚„`where`å¥ã§ã¯æ­£ç¢ºãªå‰æœˆç™ºç”Ÿã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆæ•°ã‚„æœªã‚¯ãƒ­ãƒ¼ã‚ºã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æŠŠæ¡ã—ã«ãã„ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚  
ã‚ˆã£ã¦ã€`summarize`ã«ã‚ˆã‚‹é›†ç´„ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

## Logic Appã¨Slacké€£æº

1. Logic Appã§ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©è¨­å®š  
   Logic Appã®ã€ŒRecurrenceã€ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã€æ¯Žæœˆ1æ—¥ã«ç™ºç«ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

2. Azure Monitor Logsã‚³ãƒã‚¯ã‚¿ã§KQLå®Ÿè¡Œ  
   Logic Appã«ã¯Azure Monitor Logsã‚³ãƒã‚¯ã‚¿ãŒã‚ã‚Šã€ã“ã“ã§å‰è¿°ã®KQLã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¾ã™ã€‚  
   çµæžœã¨ã—ã¦ã€å‰æœˆã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç·æ•°ã‚„æœªã‚¯ãƒ­ãƒ¼ã‚ºæ•°ãªã©ã‚’å–å¾—ã§ãã¾ã™ã€‚

3. Slackã¸ã®ãƒã‚¹ãƒˆå‡¦ç†  
   KQLã‚¯ã‚¨ãƒªã®çµæžœã‚’ã‚‚ã¨ã«ã€HTTPã‚³ãƒã‚¯ã‚¿ã‚„Slackã‚³ãƒã‚¯ã‚¿(ã¾ãŸã¯Webhook)ã‚’ç”¨ã„ã¦ã€Slackã®æŒ‡å®šãƒãƒ£ãƒ³ãƒãƒ«ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿ã—ã¾ã™ã€‚

   ä¾‹ãˆã°ã€ã‚¯ã‚¨ãƒªã‹ã‚‰å–å¾—ã—ãŸ`Message`åˆ—ã‚’ã€ãã®ã¾ã¾Slackãƒãƒ£ãƒ³ãƒãƒ«ã«ãƒã‚¹ãƒˆã™ã‚‹ã“ã¨ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Œã¾ã™ã€‚

   ```
   å‰æœˆã¯åˆè¨ˆ XX ä»¶ã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ã€ãã®ã†ã¡ YY ä»¶ãŒæœªã‚¯ãƒ­ãƒ¼ã‚ºã§ã™ã€‚
   ```

## ã¾ã¨ã‚

- `SecurityIncident`ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã”ã¨ã«è¨˜éŒ²ãŒå¢—ãˆã‚‹ãŸã‚ã€é›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
- `summarize` ã‚’ç”¨ã„ã¦ã€å‰æœˆç™ºç”Ÿåˆ†ã®ã¿ã‚’æŠ½å‡ºã—ã€æœ€çµ‚çš„ãªã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã‚«ã‚¦ãƒ³ãƒˆã‚„çŠ¶æ…‹ã‚’å–å¾—ã§ãã¾ã™ã€‚
- Logic Appã§æœˆæ¬¡ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’çµ„ã‚€ã“ã¨ã§ã€å®šæœŸçš„ã«KQLã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã€çµæžœã‚’Slacké€šçŸ¥ã™ã‚‹è‡ªå‹•åŒ–ãŒå¯èƒ½ã§ã™ã€‚

ã“ã‚Œã‚‰ã®æ‰‹é †ã‚’è¸ã‚€ã“ã¨ã§ã€æ¯Žæœˆã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆçŠ¶æ³ã‚’ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«å…±æœ‰ã—ã€é‹ç”¨ãƒãƒ¼ãƒ ã§ã®æŒ¯ã‚Šè¿”ã‚Šã‚„æ”¹å–„æ´»å‹•ã«å½¹ç«‹ã¦ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

