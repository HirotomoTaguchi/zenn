---
title: "Slack AI のようなものを自作する - Part1(検索編)"
emoji: "💻" 
type: "tech" # tech: 技術記事 / idea: アイデア記事
topics: [Slack, Azure AI, Azure OpenAI, AI Search] 
published: false
---

## はじめに

本日はSlack AIのようなものを自作するテーマでブログを書きます。Slack AIには多くの機能がありますが、今回はその中でも検索機能を模倣した自作プロジェクトについてお話しします。

## 免責事項
https://api.slack.com/methods/search.messages

## モチベーション

### フローデータをうまく活用したい

Slackの情報はどちらかというと「フローデータ」として流れていく性質のものです。しかし、長年使い続けていると、その中に貴重なナレッジが蓄積され、非常に有用な資産となることがあります。そこで、このフローデータをうまく活用するために、Slack AIのような検索機能を自作し、効率的に情報を再利用したいというモチベーションがあります。

### コストを下げたい

現在のSlack AIはワークスペース全体にライセンスが付与される形態となっており、大規模な組織ではコストが高くつきがちです。実際にはAIを必要としないユーザーにもライセンスを提供しなければならず、その分コスト負担が増してしまいます。自作することで、このコストを削減することができるのではないかという期待もあります。

## 実装方式の検討

Slack AIの検索機能を模倣するためには、いくつかの実装方法が考えられます。ここでは、検討した4つの実装方法を紹介します。

### 実装方法1. 検索サービスにSlackのメッセージを全てインデックスする

Amazon Kendra、Azure AI Search、Google Vertex AI Search などの検索サービスやデータベースに、Slackのパブリックチャンネルのメッセージを連携し、インデックスを作成する方法です。この方法では、必要に応じてベクトル検索などを組み込むことで、高度な検索機能を実現することが可能です。Azure AI Search を利用の場合はデータコネクタなどが用意されておらず、それも自作する必要がありますが、Amazon Kendra^[[]()] 、Google Vertex AI Search^[[]()] （これは試してない）では、コネクタが用意されており、簡単にデータを蓄積することができます。 

### 実装方法2. 検索サービスにSlackのメッセージを一部インデックスする

全てのメッセージをインデックスするのではなく、一部のデータのみをインデックスする方法です。Slackのデータは多くの無関係な情報も含んでいるため、すべてをインデックスすると精度が低下したり、コストが高くなる可能性があります。そのため、「ナレッジ」と見なされるメッセージにスタンプを押すことで、そのメッセージだけをインデックスするアプローチを検討しました。

### 実装方法3. SlackのSearch APIを使う

SlackにはSearch API ^[[search.messages](https://api.slack.com/methods/search.messages)] が用意されているため、それを利用する方法も考えられます。ユーザーが質問を入力した際に、OpenAI の Function Coding（Structured Output）を使って検索クエリを生成し、その結果をもとにユーザーへ回答します。この方法ではインデックスを自前で構築する必要がないためコストが最も安く、常に最新のデータをリアルタイムで検索できるという利点があります。一方で、SlackのSearch APIはリッチな検索手法ではありません。検索仕様についての情報はみつかりませんでしたが、おそらくただのキーワード検索を利用している（注意：筆者推測）ため「こんばんわ」と「こんばんは」や「Defender for Endpoint」と「MDE」といった表記揺れには弱いという傾向があります。もちろん、OpenAI の Function Coding（Structured Output）を使っての検索クエリ生成で複数検索キーワードを生成するということも考えられますが、

### 実装方法4. Notion AIを使う

Notion AIを利用してSlackのデータをインデックスし、回答を生成する方法も考えられます。Notion AIはSlackのデータだけでなく、他の情報源も統合してインデックスを作成し、それに基づいた回答を提供することができます。SlackとNotionを連携させることで、より広範な情報を検索対象にできる点が利点です。

### 採用した実装方法

以上の実装方法のメリット・デメリットを比較した結果、今回採用したのは「実装方法2」です。理由としては、全メッセージをインデックスする方法ではコストが高くなりすぎる点、また「helpme-helpyou」チャンネルなど特定のチャンネルにスタンプを押すことで、効率的に必要な情報だけをインデックスできる点が魅力的だったからです。

| 実装方法 | メリット | デメリット |
|----------|----------|------------|
| 1. 検索サービスに全メッセージをインデックス | 高度な検索機能を実現可能。 | データ量が多くなるとコストが高い。精度が下がる可能性 |
| 2. 一部メッセージをインデックス | コストが抑えられる。必要な情報だけを効率的にインデックス可能 | インデックス対象の選定が必要。見落としの可能性 |
| 3. SlackのSearch APIを使用 | インデックス構築が不要。常に最新のデータをリアルタイム検索可能 | 検索精度が他の手段に比べて低くなる傾向がある |
| 4. Notion AIを使用 | Slack以外のデータも統合して検索可能。広範な情報を対象にできる | Notion AIの契約が必要。インデックス対象が広がりすぎる可能性 |

## 実装のポイント

### データ蓄積部分

データ蓄積部分では、Function Coding（Structured Output）を使ってデータを構造化し、蓄積しています。「ナレッジ追加」というスタンプを用意し、それが押されたメッセージをトリガーにしてスレッド全体を取得します。そのスレッドを「質問」「回答」「URL」「タイトル」などの形式でデータ保存します。このデータはAzure AI Searchに保存し、カスタムスキルを使ってベクトルデータに変換する仕組みです。

### AIによる回答生成部分

AIによる回答生成部分は非常にシンプルです。ユーザーがボットにメンションをつけて質問をすると、その質問に対してベクトル検索を行い、最も関連性が高い情報を上位5件程度ピックアップしてAIに渡します。さらにFunction Codingを通じてリランキングを行うことで、より精度の高い回答を生成することが可能です。

### コスト

## 終わりに

今回はSlack AIの検索機能を模倣して自作する取り組みについて紹介しました。今後、余裕があれば他のSlack AIの機能についても自作する取り組みを進めていきたいと思います。フローデータの活用やコスト削減を目指したこのプロジェクトが、同じようなニーズを持つ方々の参考になれば幸いです。
