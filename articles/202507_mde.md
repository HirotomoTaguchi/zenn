---
title: "Microsoft Defender for Endpoint でリモートマネジメントモニタリング（RMM）ツールによる脅威を検知する"
emoji: "🛡" 
type: "tech" ## tech: 技術記事 / idea: アイデア記事
topics: [Microsoft Defender, Security] 
published: false
---

## アラートから解決まで

### 調査アプローチ

Microsoft Defender for Endpoint (MDE) で検知された不審なファイルの調査手法を解説します。受動的なアラート対応から、プロアクティブで知的な調査活動への変革を目指します。

調査は「調査のファネル」という概念に沿って進めます：
1. 初期アラート（広い視点）
2. ファイル分析（焦点を絞る）
3. 攻撃チェーン分析（挙動と影響を分析）
4. 組織全体への影響評価（再び視野を広げる）

#### 事前準備

調査開始前に以下を確認：
- MDEライセンスプラン（Plan 1, Plan 2, Defender for Business）
- 自動化レベル設定（完全自動、半自動）

## 第1章：初期トリアージ

新規アラートの迅速評価と優先順位付けを行います。

### 1.1 初期アラートの分解

Microsoft Defenderポータルの「インシデントとアラート」キューで以下を確認：

#### アラートの重大度
- **高（赤）**: APT、ランサムウェア、認証情報窃取 → 即座に対応
- **中・低・情報**: コンテキストに応じて優先順位を決定

#### 検出状態
- **防止済み/ブロック済み**: 攻撃は阻止されたが調査必要
- **検出済み**: 攻撃が進行中の可能性（緊急度高）

### 1.2 インシデントビュー：全体像の把握

単一のアラートではなく、必ずインシデント全体を確認します。

- **攻撃ストーリー**: 時系列での攻撃展開
- **インシデントグラフ**: 関連資産の視覚化

**例**: 「不審なPowerShellコマンド」単体では背景不明ですが、インシデントビューで「悪意のあるメール添付ファイル」と紐づいているとフィッシング攻撃と判明します。

### 1.3 主要エンティティの特定

以下の情報を記録：
- **影響を受けたデバイス**: ホスト名、デバイス種別
- **影響を受けたユーザー**: アカウント名、権限レベル
- **不審なファイル**: ファイル名、パス

### アラート重大度別トリアージ

| 重大度 | 典型例 | 優先度 | 初期アクション |
|--------|--------|--------|----------------|
| 高（赤） | ランサムウェア、認証情報窃取 | 緊急 | 即座にデバイス分離を検討 |
| 中 | 不審なPowerShell、Living-off-the-Land | 高 | 数時間以内に調査開始 |
| 低 | ポリシー違反ソフト、アドウェア | 中 | 1営業日以内に調査 |
| 情報 | 良性イベント | 低 | 定期レビューに含める |

## 第2章：ファイル分析

不審なファイルの詳細調査を行います。

### 2.1 ファイルプロファイルページ

アラートからファイル名またはハッシュをクリックして移動。

#### 基本メタデータの確認
- **ハッシュ値**: SHA1, SHA256, MD5
- **署名情報**: 信頼できる発行元か、署名の有効性
- **ファイル名**: 偽装の可能性（例：svchost1.exe）

### 2.2 普及率分析

#### 組織内普及率
- 1-2台のデバイスでのみ発見 → 疑わしい
- 数千台で発見 → 一般的なファイルの可能性

#### グローバル普及率
Microsoftのクラウド分析によるグローバル統計を確認。

#### 時系列情報
- **初回確認日時**: 新規攻撃キャンペーンの可能性
- **最終確認日時**: 最近の活動状況

### 2.3 評価とサンドボックス分析

#### VirusTotal連携
- 検出率の確認（例：45/70）
- 高い検出率 = 既知のマルウェア

#### 詳細分析（サンドボックス）
未知ファイルをMicrosoftサンドボックスで実行し、以下を分析：
- ネットワーク接続
- ファイル作成
- レジストリ変更

### ファイルプロファイル分析チェックリスト

| 項目 | 確認内容 | 重要度 |
|------|----------|--------|
| ファイルハッシュ | 一意識別子として記録 | 必須 |
| ファイル名 | 偽装の可能性 | 高 |
| ファイルパス | 標準的な場所か | 高 |
| 署名者 | 有効な署名か | 高 |
| 組織内普及率 | 低い = 疑わしい | 高 |
| グローバル普及率 | 稀 = 疑わしい | 中 |
| VirusTotal検出率 | 高い = マルウェア | 高 |
| サンドボックス結果 | 真の意図を把握 | 高 |

## 第3章：攻撃チェーンの再構築

タイムラインとプロセス可視化で攻撃の全体像を理解します。

### 3.1 プロセスツリー分析

#### 親子プロセスの特定
実行フローの可視化：
```
outlook.exe → winword.exe → powershell.exe → 不審なファイル
```

#### コマンドライン分析
各プロセスの起動パラメータを確認し、悪意のあるスクリプトやコマンドを特定。

### 3.2 デバイスタイムライン

最大6ヶ月間のすべてのイベントを時系列で確認。

#### フィルタリング戦略
- **実行前イベント**: ファイル到着経路の特定
- **実行後イベント**: 影響範囲の把握

#### データエクスポート
最大7日間のデータをCSVでエクスポート可能。

### 3.3 MITRE ATT&CK マッピング

イベントをMITRE ATT&CKフレームワークにマッピング。

#### 主要戦術
- **初期アクセス (TA0001)**: フィッシングなど
- **実行 (TA0002)**: コマンドとスクリプト実行
- **永続化 (TA0003)**: システムプロセス変更
- **防御回避 (TA0005)**: 偽装、ログクリア

## 第4章：追跡調査の拡大

高度な追跡（Advanced Hunting）で侵害範囲を特定します。

### 4.1 高度な追跡とKQL

Kusto Query Language (KQL) で最大30日間のデータを検索。

### 4.2 IOC追跡

特定したIOC（ハッシュ、ファイル名、IP）を組織全体で検索。

### 4.3 実用的なKQLクエリ

#### 特定ファイルハッシュの検索
```kql
DeviceFileEvents
| where SHA256 == "ここにハッシュを貼り付け"
```

#### 特定ファイル名での検索
```kql
DeviceProcessEvents  
| where FileName =~ "suspicious_file.exe"
```

#### 悪意のあるIP通信の検索
```kql
DeviceNetworkEvents
| where RemoteIP == "悪意のあるIP"
```

#### 包括的なファイル追跡
```kql
let fileHash = "ここにハッシュを貼り付け";
find in (DeviceFileEvents, DeviceProcessEvents, DeviceImageLoadEvents, DeviceRegistryEvents, DeviceNetworkEvents)
where SHA1 == fileHash or InitiatingProcessSHA1 == fileHash or SHA256 == fileHash or InitiatingProcessSHA256 == fileHash
```

## 第5章：対応と修復

調査結果に基づく対応アクションを実行します。

### 5.1 封じ込め

#### デバイスの分離
- ネットワークから切断
- 横展開の防止
- MDEサービスとの通信は維持

#### ファイルの停止と検疫
- プロセス終了
- ファイル削除
- 検疫実行

### 5.2 根絶と調査

#### ウイルス対策スキャン
リモートでフル/クイックスキャンを実行。

#### 調査パッケージ収集
法務・コンプライアンス要件でフォレンジックデータを収集。

#### ライブ応答
リモートコマンドラインでの手動調査・修復：
- コマンド実行
- ファイル操作
- プロセス管理

### 5.3 プロアクティブ強化

#### インジケーター追加
- ファイルハッシュのブロック
- 悪意のあるIP/URLのブロック

### 対応アクション一覧

| アクション | 目的 | 最適なユースケース | 注意点 |
|------------|------|-------------------|---------|
| デバイス分離 | 即時封じ込め | 緊急性の高い脅威 | 生産性への影響 |
| ファイル停止と検疫 | 特定ファイル無力化 | 既知マルウェア | ファイル存在が前提 |
| ウイルス対策スキャン | デバイス全体クリーン | 封じ込め後の清浄化 | CPUリソース消費 |
| 調査パッケージ収集 | フォレンジック証拠 | 法務・コンプライアンス | 大容量、時間要 |
| ライブ応答 | 外科的修復 | 高度な調査・修復 | 高度スキル必要 |
| インジケーター追加 | 将来の攻撃防止 | 既知脅威の再発防止 | 管理・有効期限要 |
